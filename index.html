<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AnglerPage ‚Äî Free Feed</title>
  <style>
    :root{
      --bg:#0b120d; --card:#121b12; --text:#f3f1e7; --muted:#c9c2aa; --line:#2c3a2b; --accent:#7aa35a;
      --danger:#ff6b6b; --ok:#77d18a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit}
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(18,27,18,.92);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(180deg, rgba(122,163,90,.28), rgba(176,138,90,.12));
      border:1px solid rgba(255,255,255,.10);
      font-weight:800;
    }
    .brand h1{font-size:16px;margin:0;line-height:1.1}
    .brand small{display:block;color:var(--muted);font-weight:500;margin-top:2px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer; transition:.15s; font-weight:650;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:rgba(122,163,90,.22);border-color:rgba(122,163,90,.42)}
    .btn.danger{background:rgba(255,107,107,.16);border-color:rgba(255,107,107,.36)}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:650}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--muted); font-size:12px;
    }
    .grid{display:grid;grid-template-columns: 1fr; gap:12px; padding:16px}
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .card .pad{padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .between{justify-content:space-between}
    .muted{color:var(--muted)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .avatar{
      width:40px;height:40px;border-radius:14px;flex:0 0 auto;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      object-fit:cover;
    }
    .who .name{font-weight:800}
    .who .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .post-media{background:#0a0f0b}
    .post-media img, .post-media video{
      width:100%; display:block; max-height:520px; object-fit:cover;
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .action{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      cursor:pointer; user-select:none; font-weight:700;
    }
    .action:hover{filter:brightness(1.08)}
    .action small{color:var(--muted);font-weight:700}
    input, textarea, select{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--text); outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .two{grid-template-columns:1fr} }
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(18,27,18,.95);border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;border-radius:12px;
      max-width:92vw; display:none;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
      z-index:99;
    }
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;z-index:50;
      padding:16px;
    }
    .modal{
      width:min(760px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:var(--card);
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modal .head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal .body{padding:14px}
    .modal .foot{padding:14px;border-top:1px solid rgba(255,255,255,.08);display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi .pill strong{color:var(--text)}
    .progress{
      display:none;
      width:100%;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
      margin-top:10px;
    }
    .progress > div{
      height:100%;
      width:0%;
      background:rgba(122,163,90,.6);
      transition:width .15s ease;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">AP</div>
        <div>
          <h1>AnglerPage</h1>
          <small>Free fishing feed ‚Ä¢ Cloudinary media</small>
        </div>
      </div>

      <div class="nav">
        <button id="tabFeed" class="btn small primary">Feed</button>
        <button id="tabProfile" class="btn small">My Profile</button>
        <button id="btnCreate" class="btn small primary">+ Post</button>
        <button id="btnAuth" class="btn small">Sign in</button>
        <button id="btnSignOut" class="btn small danger" style="display:none;">Sign out</button>
      </div>
    </div>

    <div class="row between" style="margin-top:10px;">
      <div class="row" style="gap:10px;">
        <span id="authState" class="pill">Not signed in</span>
        <span class="pill">Collections: <strong>profiles</strong>, <strong>posts</strong></span>
      </div>
      <div class="row" style="gap:10px;">
        <input id="search" placeholder="Search titles, captions, creators‚Ä¶" style="width:min(360px,70vw)" />
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- FEED -->
    <section id="viewFeed" class="card">
      <div class="pad">
        <div class="row between">
          <div>
            <div style="font-weight:900;font-size:16px;">Latest posts</div>
            <div class="muted" style="font-size:12px;margin-top:2px;">Everyone can view. Posting requires sign-in.</div>
          </div>
          <div class="kpi">
            <span class="pill">Loaded: <strong id="kpiLoaded">0</strong></span>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <div id="feedList"></div>
      <div class="pad" id="feedEmpty" style="display:none;">
        <div class="muted">No posts yet. Be the first to post.</div>
      </div>
      <div class="pad">
        <button id="btnLoadMore" class="btn">Load more</button>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="viewProfile" class="card" style="display:none;">
      <div class="pad">
        <div class="row between">
          <div class="row" style="gap:12px;">
            <img id="meAvatar" class="avatar" alt="me" />
            <div class="who">
              <div id="meName" class="name">‚Äî</div>
              <div id="meMeta" class="meta">Sign in to manage your profile</div>
            </div>
          </div>
          <div class="actions">
            <button id="btnEditProfile" class="btn small">Edit profile</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="two">
          <div>
            <label>Bio</label>
            <div id="meBio" class="muted">‚Äî</div>
          </div>
          <div>
            <label>Location</label>
            <div id="meLocation" class="muted">‚Äî</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row between">
          <div style="font-weight:900;">My posts</div>
          <span class="pill">Only you can delete your posts</span>
        </div>
      </div>
      <div id="myPosts"></div>
      <div class="pad" id="myPostsEmpty" style="display:none;">
        <div class="muted">You haven‚Äôt posted anything yet.</div>
      </div>
    </section>

  </div>
</main>

<!-- CREATE POST MODAL -->
<div id="createBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="head">
      <div style="font-weight:900;">Create a post</div>
      <button class="btn small ghost" onclick="closeCreate()">‚úï</button>
    </div>

    <div class="body">
      <div class="two">
        <div>
          <label>Title</label>
          <input id="postTitle" maxlength="120" placeholder="Quick title (optional)" />
        </div>
        <div>
          <label>Media type</label>
          <select id="postType">
            <option value="image">Image</option>
            <option value="video">Video</option>
          </select>
        </div>
      </div>

      <label>Upload media (Cloudinary)</label>
      <div class="two">
        <div>
          <input id="postFile" type="file" accept="image/*,video/*" />
          <div class="hint">Pick a file and upload; we‚Äôll fill the Media URL for you.</div>
        </div>
        <div>
          <button id="btnUpload" class="btn" type="button" onclick="uploadToCloudinary()">Upload</button>
          <div class="progress" id="upProg"><div id="upProgBar"></div></div>
          <div class="hint" id="upHint"></div>
        </div>
      </div>

      <label>Media URL (auto-filled after upload, or paste your own)</label>
      <input id="postMediaUrl" maxlength="800" placeholder="https://..." />
      <div class="hint">Rules allow http(s) URLs. Cloudinary ‚Äúsecure_url‚Äù works best.</div>

      <label>Caption</label>
      <textarea id="postCaption" maxlength="1000" placeholder="Tell the story‚Ä¶"></textarea>

      <div class="two">
        <div>
          <label>Tags (comma-separated)</label>
          <input id="postTags" maxlength="200" placeholder="bass, kayak, river" />
        </div>
        <div>
          <label>State (optional)</label>
          <input id="postState" maxlength="30" placeholder="WI" />
        </div>
      </div>

      <div class="hint">Free feed: no prices, no unlocks.</div>
    </div>

    <div class="foot">
      <button class="btn" onclick="closeCreate()">Cancel</button>
      <button id="btnPublish" class="btn primary" onclick="publishPost()">Publish</button>
    </div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div id="profileBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="head">
      <div style="font-weight:900;">Edit profile</div>
      <button class="btn small ghost" onclick="closeProfile()">‚úï</button>
    </div>
    <div class="body">
      <label>Display name</label>
      <input id="profileName" maxlength="60" placeholder="Your name" />

      <label>Avatar URL (optional)</label>
      <input id="profileAvatar" maxlength="800" placeholder="https://..." />

      <div class="two">
        <div>
          <label>Location (optional)</label>
          <input id="profileLocation" maxlength="60" placeholder="Madison, WI" />
        </div>
        <div>
          <label>Favorite species (optional)</label>
          <input id="profileSpecies" maxlength="60" placeholder="Walleye" />
        </div>
      </div>

      <label>Bio (optional)</label>
      <textarea id="profileBio" maxlength="300" placeholder="A short bio‚Ä¶"></textarea>

      <div class="hint">Profiles are public. Keep it simple.</div>
    </div>
    <div class="foot">
      <button class="btn" onclick="closeProfile()">Cancel</button>
      <button id="btnSaveProfile" class="btn primary" onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  // Firebase (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, addDoc, serverTimestamp,
    query, orderBy, limit, startAfter, getDocs, where,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // =======================
  // 1) FIREBASE CONFIG
  // =======================
  const firebaseConfig = {
    apiKey: "PASTE",
    authDomain: "PASTE",
    projectId: "PASTE",
    storageBucket: "PASTE",
    messagingSenderId: "PASTE",
    appId: "PASTE"
  };

  // =======================
  // 2) CLOUDINARY CONFIG
  // =======================
  // Keep these the same as before (replace with your real values)
  const CLOUDINARY_CLOUD_NAME = "YOUR_CLOUD_NAME";
  const CLOUDINARY_UPLOAD_PRESET = "YOUR_UNSIGNED_UPLOAD_PRESET";
  // Optional: folder in your Cloudinary media library
  const CLOUDINARY_FOLDER = "anglerpage";

  // Collections (match common rules we built earlier)
  const COL_PROFILES = "profiles";
  const COL_POSTS = "posts";

  // init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI refs
  const tabFeed = document.getElementById('tabFeed');
  const tabProfile = document.getElementById('tabProfile');
  const viewFeed = document.getElementById('viewFeed');
  const viewProfile = document.getElementById('viewProfile');
  const btnAuth = document.getElementById('btnAuth');
  const btnSignOut = document.getElementById('btnSignOut');
  const btnCreate = document.getElementById('btnCreate');
  const authState = document.getElementById('authState');
  const feedList = document.getElementById('feedList');
  const feedEmpty = document.getElementById('feedEmpty');
  const btnLoadMore = document.getElementById('btnLoadMore');
  const searchBox = document.getElementById('search');
  const kpiLoaded = document.getElementById('kpiLoaded');

  const meAvatar = document.getElementById('meAvatar');
  const meName = document.getElementById('meName');
  const meMeta = document.getElementById('meMeta');
  const meBio = document.getElementById('meBio');
  const meLocation = document.getElementById('meLocation');
  const myPosts = document.getElementById('myPosts');
  const myPostsEmpty = document.getElementById('myPostsEmpty');
  const btnEditProfile = document.getElementById('btnEditProfile');

  const createBackdrop = document.getElementById('createBackdrop');
  const profileBackdrop = document.getElementById('profileBackdrop');

  // form
  const postTitle = document.getElementById('postTitle');
  const postType = document.getElementById('postType');
  const postFile = document.getElementById('postFile');
  const postMediaUrl = document.getElementById('postMediaUrl');
  const postCaption = document.getElementById('postCaption');
  const postTags = document.getElementById('postTags');
  const postState = document.getElementById('postState');
  const btnPublish = document.getElementById('btnPublish');

  const profileName = document.getElementById('profileName');
  const profileAvatar = document.getElementById('profileAvatar');
  const profileLocation = document.getElementById('profileLocation');
  const profileSpecies = document.getElementById('profileSpecies');
  const profileBio = document.getElementById('profileBio');
  const btnSaveProfile = document.getElementById('btnSaveProfile');

  // upload UI
  const upProg = document.getElementById('upProg');
  const upProgBar = document.getElementById('upProgBar');
  const upHint = document.getElementById('upHint');
  const btnUpload = document.getElementById('btnUpload');

  // state
  let me = null;
  let lastDoc = null;
  let loading = false;
  const PAGE_SIZE = 8;
  let cachedPosts = [];

  // helpers
  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display='none', 2400);
  }
  function fmtTime(ts){
    if(!ts) return '‚Äî';
    try{
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }catch(e){ return '‚Äî'; }
  }
  function sanitizeTags(raw){
    return (raw || "").split(',')
      .map(s => s.trim().toLowerCase())
      .filter(Boolean)
      .slice(0, 12);
  }
  function isHttpUrl(s){ return /^https?:\/\/.+/i.test(s || ""); }
  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function placeholderAvatar(letter){
    const L = (letter || "A").toUpperCase();
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'>
        <rect width='100%' height='100%' fill='#1a241a'/>
        <text x='50%' y='55%' font-size='28' fill='#c9c2aa' text-anchor='middle' font-family='Arial'>${L}</text>
      </svg>`
    );
  }

  // routing
  function showFeed(){
    viewFeed.style.display = '';
    viewProfile.style.display = 'none';
    tabFeed.classList.add('primary');
    tabProfile.classList.remove('primary');
  }
  function showProfile(){
    viewFeed.style.display = 'none';
    viewProfile.style.display = '';
    tabProfile.classList.add('primary');
    tabFeed.classList.remove('primary');
    refreshProfileUI();
    refreshMyPosts();
  }
  tabFeed.onclick = showFeed;
  tabProfile.onclick = showProfile;

  // modals
  window.closeCreate = () => { createBackdrop.style.display = 'none'; };
  window.openCreate  = () => { createBackdrop.style.display = 'flex'; };
  window.closeProfile = () => { profileBackdrop.style.display = 'none'; };
  window.openProfile  = () => { profileBackdrop.style.display = 'flex'; };

  createBackdrop.addEventListener('click', (e)=>{ if(e.target === createBackdrop) window.closeCreate(); });
  profileBackdrop.addEventListener('click', (e)=>{ if(e.target === profileBackdrop) window.closeProfile(); });

  btnCreate.onclick = () => {
    if(!me){ toast("Sign in to post"); return; }
    postTitle.value = "";
    postType.value = "image";
    postFile.value = "";
    postMediaUrl.value = "";
    postCaption.value = "";
    postTags.value = "";
    postState.value = "";
    upHint.textContent = "";
    upProg.style.display = "none";
    upProgBar.style.width = "0%";
    window.openCreate();
  };

  btnEditProfile.onclick = async () => {
    if(!me){ toast("Sign in first"); return; }
    const ref = doc(db, COL_PROFILES, me.uid);
    const snap = await getDoc(ref);
    const d = snap.exists() ? snap.data() : {};

    profileName.value = d.displayName || me.displayName || "";
    profileAvatar.value = d.photoURL || me.photoURL || "";
    profileLocation.value = d.location || "";
    profileSpecies.value = d.favoriteSpecies || "";
    profileBio.value = d.bio || "";
    window.openProfile();
  };

  // auth
  btnAuth.onclick = async () => {
    const provider = new GoogleAuthProvider();
    try{
      await signInWithPopup(auth, provider);
    }catch(e){
      // Popup often fails on mobile in-app browsers; redirect is the reliable fallback
      if((e?.code || "").includes("popup") || (e?.message || "").toLowerCase().includes("popup")){
        try{
          await signInWithRedirect(auth, provider);
        }catch(e2){
          console.error(e2);
          toast(e2?.message || "Sign-in failed");
        }
      }else{
        console.error(e);
        toast(e?.message || "Sign-in failed");
      }
    }
  };

  btnSignOut.onclick = async () => {
    try{ await signOut(auth); } catch(e){ toast("Sign-out failed"); }
  };

  // Handle redirect result (important on mobile)
  try{
    await getRedirectResult(auth);
  }catch(e){
    // ignore unless you want to show it
  }

  // ========= PROFILES (THIS IS WHERE THE OLD ERROR USUALLY WAS) =========
  async function ensureProfileDoc(user){
    // Use setDoc merge so it works whether doc exists or not.
    const ref = doc(db, COL_PROFILES, user.uid);
    const base = {
      uid: user.uid,
      displayName: user.displayName || "Angler",
      photoURL: user.photoURL || "",
      bio: "",
      location: "",
      favoriteSpecies: "",
      updatedAt: serverTimestamp()
    };
    // createdAt only if doc doesn't exist (avoid rule issues if disallowed to add new fields later)
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, { ...base, createdAt: serverTimestamp() }, { merge: true });
    }else{
      // don‚Äôt blank out user‚Äôs fields
      const d = snap.data() || {};
      await setDoc(ref, {
        ...base,
        displayName: d.displayName || base.displayName,
        photoURL: d.photoURL || base.photoURL,
        bio: d.bio || "",
        location: d.location || "",
        favoriteSpecies: d.favoriteSpecies || ""
      }, { merge: true });
    }
  }

  window.saveProfile = async () => {
    if(!me){ toast("Sign in first"); return; }

    const dn  = (profileName.value || "").trim().slice(0,60);
    const av  = (profileAvatar.value || "").trim().slice(0,800);
    const loc = (profileLocation.value || "").trim().slice(0,60);
    const sp  = (profileSpecies.value || "").trim().slice(0,60);
    const bio = (profileBio.value || "").trim().slice(0,300);

    if(av && !isHttpUrl(av)){ toast("Avatar URL must start with http(s)://"); return; }

    btnSaveProfile.disabled = true;
    try{
      await setDoc(doc(db, COL_PROFILES, me.uid), {
        uid: me.uid,
        displayName: dn || (me.displayName || "Angler"),
        photoURL: av || "",
        location: loc || "",
        favoriteSpecies: sp || "",
        bio: bio || "",
        updatedAt: serverTimestamp()
      }, { merge: true });

      toast("Profile saved");
      window.closeProfile();
      await refreshProfileUI();
      await refreshMyPosts();
    }catch(e){
      console.error(e);
      toast(e?.message || "Save failed (check rules)");
    }finally{
      btnSaveProfile.disabled = false;
    }
  };

  async function refreshProfileUI(){
    if(!me){
      meAvatar.src = "";
      meName.textContent = "‚Äî";
      meMeta.textContent = "Sign in to manage your profile";
      meBio.textContent = "‚Äî";
      meLocation.textContent = "‚Äî";
      return;
    }
    const ref = doc(db, COL_PROFILES, me.uid);
    const snap = await getDoc(ref);
    const d = snap.exists() ? snap.data() : {};

    const dn = d.displayName || me.displayName || "Angler";
    const photo = d.photoURL || me.photoURL || "";
    meAvatar.src = photo || placeholderAvatar((dn[0] || "A"));
    meName.textContent = dn;
    meMeta.textContent = me.email || "";
    meBio.textContent = d.bio ? d.bio : "‚Äî";
    meLocation.textContent = d.location ? d.location : "‚Äî";
  }

  // ========= POSTS =========
  function renderPostCard(p, opts={mine:false}){
    const media = p.mediaUrl ? (p.type === 'video'
      ? `<video src="${esc(p.mediaUrl)}" controls playsinline></video>`
      : `<img src="${esc(p.mediaUrl)}" alt="post" loading="lazy" />`)
      : "";

    const tags = (p.tags || []).map(t => `<span class="pill">#${esc(t)}</span>`).join(" ");
    const mineBtns = opts.mine ? `<button class="btn small danger" data-del="${esc(p.id)}">Delete</button>` : "";

    const authorLetter = (p.authorName || "A")[0] || "A";
    const authorPhoto = (p.authorPhoto && isHttpUrl(p.authorPhoto)) ? p.authorPhoto : placeholderAvatar(authorLetter);

    return `
      <article class="card" style="margin:12px 16px;">
        <div class="pad">
          <div class="row between">
            <div class="row" style="gap:12px;">
              <img class="avatar" src="${esc(authorPhoto)}" alt="avatar" />
              <div class="who">
                <div class="name">${esc(p.authorName || "Angler")}</div>
                <div class="meta">${esc(fmtTime(p.createdAt))}${p.state ? " ‚Ä¢ "+esc(p.state) : ""}</div>
              </div>
            </div>
            <div class="row" style="gap:8px;">${mineBtns}</div>
          </div>

          ${p.title ? `<div style="font-weight:900;margin-top:10px;">${esc(p.title)}</div>` : ""}
          ${p.caption ? `<div class="muted" style="margin-top:8px;white-space:pre-wrap;">${esc(p.caption)}</div>` : ""}
          ${tags ? `<div class="row" style="margin-top:10px;gap:8px;">${tags}</div>` : ""}

          <div class="divider"></div>

          <div class="actions">
            <div class="action" data-copy="${esc(p.id)}">üîó Share</div>
          </div>
        </div>
        ${media ? `<div class="post-media">${media}</div>` : ""}
      </article>
    `;
  }

  function wirePostActions(root){
    root.querySelectorAll('[data-copy]').forEach(el=>{
      el.onclick = async () => {
        const id = el.getAttribute('data-copy');
        const url = location.origin + location.pathname + "#post=" + id;
        try{
          await navigator.clipboard.writeText(url);
          toast("Link copied");
        }catch(e){
          toast("Copy failed");
        }
      };
    });

    root.querySelectorAll('[data-del]').forEach(el=>{
      el.onclick = async () => {
        if(!me){ toast("Sign in"); return; }
        const id = el.getAttribute('data-del');
        if(!confirm("Delete this post?")) return;
        try{
          await deleteDoc(doc(db, COL_POSTS, id));
          toast("Deleted");
          await refreshMyPosts();
          await fetchPage(true);
        }catch(e){
          console.error(e);
          toast(e?.message || "Delete failed (check rules)");
        }
      };
    });
  }

  async function fetchPage(reset=false){
    if(loading) return;
    loading = true;
    btnLoadMore.disabled = true;

    try{
      if(reset){
        lastDoc = null;
        cachedPosts = [];
        feedList.innerHTML = "";
        kpiLoaded.textContent = "0";
      }

      const base = collection(db, COL_POSTS);
      let qy = query(base, orderBy("createdAt","desc"), limit(PAGE_SIZE));
      if(lastDoc) qy = query(base, orderBy("createdAt","desc"), startAfter(lastDoc), limit(PAGE_SIZE));

      const snap = await getDocs(qy);
      if(snap.empty && cachedPosts.length === 0){
        feedEmpty.style.display = "";
        return;
      }
      feedEmpty.style.display = "none";

      lastDoc = snap.docs[snap.docs.length-1] || lastDoc;
      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      cachedPosts.push(...items);

      kpiLoaded.textContent = String(cachedPosts.length);

      feedList.insertAdjacentHTML("beforeend", items.map(p => renderPostCard(p)).join(""));
      wirePostActions(feedList);
    }catch(e){
      console.error(e);
      toast(e?.message || "Failed to load feed");
    }finally{
      loading = false;
      btnLoadMore.disabled = false;
    }
  }

  btnLoadMore.onclick = () => fetchPage(false);

  // client-side search on cached posts
  function applySearch(){
    const q = (searchBox.value || "").trim().toLowerCase();
    if(!q){
      feedList.innerHTML = cachedPosts.map(p => renderPostCard(p)).join("");
      wirePostActions(feedList);
      feedEmpty.style.display = cachedPosts.length ? "none" : "";
      kpiLoaded.textContent = String(cachedPosts.length);
      return;
    }

    const filtered = cachedPosts.filter(p => {
      const hay = [
        p.title, p.caption, p.authorName, (p.tags||[]).join(" "), p.state
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

    feedList.innerHTML = filtered.map(p => renderPostCard(p)).join("");
    wirePostActions(feedList);
    feedEmpty.style.display = filtered.length ? "none" : "";
    kpiLoaded.textContent = String(filtered.length);
  }

  searchBox.addEventListener('input', applySearch);

  // publish post
  window.publishPost = async () => {
    if(!me){ toast("Sign in to post"); return; }

    const title = (postTitle.value || "").trim().slice(0,120);
    const type = (postType.value === "video") ? "video" : "image";
    const mediaUrl = (postMediaUrl.value || "").trim().slice(0,800);
    const caption = (postCaption.value || "").trim().slice(0,1000);
    const tags = sanitizeTags(postTags.value || "");
    const state = (postState.value || "").trim().slice(0,30);

    if(mediaUrl && !isHttpUrl(mediaUrl)){ toast("Media URL must start with http(s)://"); return; }
    if(!caption && !mediaUrl && !title){ toast("Add at least a title, caption, or media URL"); return; }

    btnPublish.disabled = true;
    try{
      // denormalize profile for feed (common + fast)
      const pref = doc(db, COL_PROFILES, me.uid);
      const psnap = await getDoc(pref);
      const p = psnap.exists() ? psnap.data() : {};

      await addDoc(collection(db, COL_POSTS), {
        ownerId: me.uid,
        authorName: p.displayName || me.displayName || "Angler",
        authorPhoto: p.photoURL || me.photoURL || "",
        title,
        caption,
        type,
        mediaUrl,
        tags,
        state,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      toast("Posted!");
      window.closeCreate();
      await fetchPage(true);
      showFeed();
      await refreshMyPosts();
    }catch(e){
      console.error(e);
      toast(e?.message || "Publish failed (check rules)");
    }finally{
      btnPublish.disabled = false;
    }
  };

  async function refreshMyPosts(){
    if(!me){
      myPosts.innerHTML = "";
      myPostsEmpty.style.display = "";
      return;
    }

    myPosts.innerHTML = "";
    myPostsEmpty.style.display = "none";

    try{
      const qy = query(
        collection(db, COL_POSTS),
        where("ownerId","==",me.uid),
        orderBy("createdAt","desc"),
        limit(30)
      );

      const snap = await getDocs(qy);
      if(snap.empty){
        myPostsEmpty.style.display = "";
        return;
      }

      const items = snap.docs.map(d=>({id:d.id, ...d.data()}));
      myPosts.innerHTML = items.map(p => renderPostCard(p, {mine:true})).join("");
      wirePostActions(myPosts);
    }catch(e){
      console.error(e);
      toast(e?.message || "Failed to load your posts");
    }
  }

  // ========= CLOUDINARY UPLOAD =========
  window.uploadToCloudinary = async () => {
    if(!me){ toast("Sign in first"); return; }
    const file = postFile.files && postFile.files[0];
    if(!file){ toast("Choose a file first"); return; }
    if(!CLOUDINARY_CLOUD_NAME || CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME"){
      toast("Set your Cloudinary cloud name/preset in the code first");
      return;
    }

    // Cloudinary unsigned upload endpoint
    const endpoint = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUDINARY_CLOUD_NAME)}/auto/upload`;

    btnUpload.disabled = true;
    upHint.textContent = "Uploading‚Ä¶";
    upProg.style.display = "block";
    upProgBar.style.width = "8%";

    try{
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
      if(CLOUDINARY_FOLDER) fd.append("folder", CLOUDINARY_FOLDER);

      // Progress: fetch doesn‚Äôt expose upload progress reliably; we simulate steps
      const timer = setInterval(()=>{
        const cur = parseFloat(upProgBar.style.width) || 0;
        if(cur < 92) upProgBar.style.width = (cur + 6) + "%";
      }, 180);

      const res = await fetch(endpoint, { method:"POST", body: fd });
      clearInterval(timer);

      const json = await res.json();
      if(!res.ok){
        console.error(json);
        throw new Error(json?.error?.message || "Cloudinary upload failed");
      }

      // prefer secure_url
      const url = json.secure_url || json.url;
      if(!url) throw new Error("Upload succeeded but no URL returned");

      postMediaUrl.value = url;
      upProgBar.style.width = "100%";
      upHint.textContent = "Uploaded ‚úì URL filled in.";
      toast("Upload complete");
    }catch(e){
      console.error(e);
      upHint.textContent = "Upload failed.";
      toast(e?.message || "Upload failed");
      upProgBar.style.width = "0%";
      upProg.style.display = "none";
    }finally{
      btnUpload.disabled = false;
    }
  };

  // ========= AUTH STATE =========
  onAuthStateChanged(auth, async (user) => {
    me = user || null;

    if(!me){
      authState.textContent = "Not signed in";
      btnAuth.style.display = "";
      btnSignOut.style.display = "none";
      btnCreate.disabled = true;
      await refreshProfileUI();
      await refreshMyPosts();
      return;
    }

    btnAuth.style.display = "none";
    btnSignOut.style.display = "";
    btnCreate.disabled = false;

    authState.textContent = `Signed in: ${me.displayName || me.email || "User"}`;

    try{
      await ensureProfileDoc(me);
    }catch(e){
      console.error(e);
      // This is the ‚Äúprofile create/save‚Äù rules mismatch symptom
      toast("Profile init failed (Firestore rules mismatch)");
    }

    await refreshProfileUI();
    await refreshMyPosts();
  });

  // initial
  showFeed();
  fetchPage(true);
</script>
</body>
</html>
