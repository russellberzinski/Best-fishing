<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BestFishingSecrets — Feed</title>
  <meta name="description" content="Public sneak peeks. Sign in to post. Creators can delete their own posts." />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a33; --card2:#0d1730; --text:#e8edf7; --muted:#b7c0d6; --line:#223152;
      --accent:#60a5fa; --danger:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{padding:16px;border-bottom:1px solid var(--line);background:var(--card);position:sticky;top:0;z-index:5}
    .top{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .btn{border:1px solid var(--line);background:transparent;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{border-color:transparent;background:var(--accent);color:#061121;font-weight:800}
    .btn.danger{border-color:transparent;background:var(--danger);color:#1b0b0b;font-weight:800}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .status{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--muted);margin-bottom:12px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .composer{border:1px solid var(--line);background:var(--card);border-radius:var(--radius);padding:12px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input, textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:var(--card2);color:var(--text);outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{border:1px solid var(--line);border-radius:var(--radius);background:var(--card);overflow:hidden}
    .thumb{aspect-ratio:16/9;background:#0a1020;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px}
    .meta h3{margin:0 0 6px;font-size:14px}
    .sub{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap}
    .actions{margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted);font-size:12px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:18px;background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.16);
      color:#fff;padding:10px 12px;border-radius:12px;display:none;max-width:min(92vw,720px)
    }
  </style>
</head>

<body>
  <header>
    <div class="top">
      <h1>BestFishingSecrets — Public Feed</h1>
      <div class="row" style="width:auto">
        <button id="loginBtn" class="btn primary">Sign in</button>
        <button id="logoutBtn" class="btn" style="display:none">Sign out</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="status">
      <div>
        <div id="authLine">Status: Not signed in</div>
        <div style="font-size:12px;color:var(--muted)">Anyone can read. Sign in to post. Creators can delete their own posts.</div>
      </div>
      <div class="pill" id="modePill">Public read</div>
    </div>

    <section class="composer" id="composer" style="display:none">
      <div class="row">
        <input id="title" placeholder="Title (example: Winter bass bite - sneak peek)" maxlength="120" />
      </div>
      <div class="row" style="margin-top:10px">
        <textarea id="teaser" placeholder="Teaser text (keep it short)..."></textarea>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="thumbUrl" placeholder="Thumbnail image URL (optional)" />
      </div>
      <div class="row" style="margin-top:10px;align-items:center;justify-content:space-between">
        <div style="color:var(--muted);font-size:12px">Tip: If you use Cloudinary, paste the secure image URL here.</div>
        <button id="postBtn" class="btn primary">Post</button>
      </div>
    </section>

    <section>
      <div class="grid" id="feed"></div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Firebase (v10 modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ✅ PASTE YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "PASTE_YOURS",
      authDomain: "PASTE_YOURS",
      projectId: "PASTE_YOURS",
      storageBucket: "PASTE_YOURS",
      messagingSenderId: "PASTE_YOURS",
      appId: "PASTE_YOURS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const el = (id) => document.getElementById(id);
    const toast = (msg) => {
      el("toast").textContent = msg;
      el("toast").style.display = "block";
      setTimeout(() => (el("toast").style.display = "none"), 2600);
    };

    const feedEl = el("feed");
    let currentUser = null;

    // AUTH UI
    el("loginBtn").onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        toast(e?.message || "Sign in failed");
      }
    };

    el("logoutBtn").onclick = async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
        toast("Sign out failed");
      }
    };

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;

      if (currentUser) {
        el("authLine").textContent = `Signed in as: ${currentUser.displayName || currentUser.email}`;
        el("loginBtn").style.display = "none";
        el("logoutBtn").style.display = "inline-block";
        el("composer").style.display = "block";
        el("modePill").textContent = "Signed in";
      } else {
        el("authLine").textContent = "Status: Not signed in";
        el("loginBtn").style.display = "inline-block";
        el("logoutBtn").style.display = "none";
        el("composer").style.display = "none";
        el("modePill").textContent = "Public read";
      }
    });

    // CREATE POST (stores uid so delete permissions can work)
    el("postBtn").onclick = async () => {
      if (!currentUser) return toast("Please sign in first.");

      const title = el("title").value.trim();
      const teaser = el("teaser").value.trim();
      const thumbUrl = el("thumbUrl").value.trim();

      if (!title || !teaser) return toast("Add a title + teaser.");

      el("postBtn").disabled = true;
      try {
        await addDoc(collection(db, "posts"), {
          title,
          teaser,
          thumbUrl: thumbUrl || "",
          uid: currentUser.uid,                              // ✅ REQUIRED for ownership
          authorName: currentUser.displayName || "",
          authorEmail: currentUser.email || "",
          createdAt: serverTimestamp()
        });

        el("title").value = "";
        el("teaser").value = "";
        el("thumbUrl").value = "";
        toast("Posted!");
      } catch (e) {
        console.error(e);
        toast(e?.message || "Post failed");
      } finally {
        el("postBtn").disabled = false;
      }
    };

    // DELETE POST (only shows button if currentUser owns it)
    async function deletePost(postId) {
      if (!currentUser) return toast("Sign in first.");
      try {
        await deleteDoc(doc(db, "posts", postId));
        toast("Deleted.");
      } catch (e) {
        console.error(e);
        toast(e?.message || "Delete failed (check rules).");
      }
    }

    // FEED LISTENER
    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
      feedEl.innerHTML = "";
      snap.forEach((d) => {
        const p = d.data();
        const postId = d.id;

        const canDelete = currentUser && p.uid && currentUser.uid === p.uid;

        const card = document.createElement("div");
        card.className = "card";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        if (p.thumbUrl) {
          const img = document.createElement("img");
          img.src = p.thumbUrl;
          img.alt = p.title || "thumbnail";
          img.loading = "lazy";
          thumb.appendChild(img);
        } else {
          thumb.textContent = "No thumbnail";
        }

        const meta = document.createElement("div");
        meta.className = "meta";

        const h3 = document.createElement("h3");
        h3.textContent = p.title || "Untitled";

        const sub = document.createElement("div");
        sub.className = "sub";
        const author = (p.authorName || p.authorEmail || "Anonymous").trim();
        sub.textContent = author ? `By ${author}` : "By Anonymous";

        const teaser = document.createElement("div");
        teaser.style.marginTop = "10px";
        teaser.style.color = "var(--text)";
        teaser.style.fontSize = "13px";
        teaser.textContent = p.teaser || "";

        const actions = document.createElement("div");
        actions.className = "actions";

        const left = document.createElement("div");
        left.className = "pill";
        left.textContent = canDelete ? "Your post" : "Public";

        const right = document.createElement("div");
        if (canDelete) {
          const delBtn = document.createElement("button");
          delBtn.className = "btn danger";
          delBtn.textContent = "Delete";
          delBtn.onclick = () => {
            const ok = confirm("Delete this post?");
            if (ok) deletePost(postId);
          };
          right.appendChild(delBtn);
        }

        actions.appendChild(left);
        actions.appendChild(right);

        meta.appendChild(h3);
        meta.appendChild(sub);
        meta.appendChild(teaser);
        meta.appendChild(actions);

        card.appendChild(thumb);
        card.appendChild(meta);
        feedEl.appendChild(card);
      });
    });
  </script>
</body>
</html>
