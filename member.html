<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Member — BestFishingSecrets</title>
  <style>
    :root{
      --bg:#0b120d; --card:#121b12; --text:#f3f1e7; --muted:#c9c2aa; --line:#2c3a2b; --accent:#7aa35a;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{padding:18px 16px;border-bottom:1px solid var(--line);background:var(--card);position:sticky;top:0;z-index:5}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{border:1px solid var(--line);border-radius:16px;background:var(--card);padding:14px;margin-bottom:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .avatar{width:76px;height:76px;border-radius:16px;border:1px solid var(--line);object-fit:cover;background:#0e1510}
    .name{font-weight:900;font-size:18px;margin:0}
    .meta{color:var(--muted);font-size:13px;margin:6px 0 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .post-img{width:100%;border-radius:14px;border:1px solid var(--line);display:block;margin:0 0 10px 0;background:#0e1510}
    .title{font-weight:800;margin:0 0 6px;font-size:16px}
    .pill{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <div><b>BestFishingSecrets</b> — Member</div>
    <div><a href="index.html">← Back to feed</a></div>
  </div>
</header>

<div class="wrap">
  <div id="status" class="card">Loading… (v2)</div>

  <div id="profileCard" class="card" style="display:none">
    <div class="row">
      <img id="avatar" class="avatar" alt="Profile photo">
      <div>
        <p id="name" class="name"></p>
        <p id="homeState" class="meta"></p>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div><b>Posts</b></div>
      <span id="count" class="pill">0</span>
    </div>
  </div>

  <div id="grid" class="grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, collection, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCndtMlIb_Y_YCP1RO-ctfizRU6q1MGeHY",
  authDomain: "bestfishingsecrets-932cf.firebaseapp.com",
  projectId: "bestfishingsecrets-932cf",
  storageBucket: "bestfishingsecrets-932cf.firebasestorage.app",
  messagingSenderId: "387299114354",
  appId: "1:387299114354:web:cbadda074f9dd7083ef1eb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const statusEl = document.getElementById("status");
const profileCard = document.getElementById("profileCard");
const avatarEl = document.getElementById("avatar");
const nameEl = document.getElementById("name");
const homeStateEl = document.getElementById("homeState");

const gridEl = document.getElementById("grid");
const countEl = document.getElementById("count");

const params = new URLSearchParams(location.search);
const uid = params.get("uid");

if (!uid){
  statusEl.textContent = "❌ Missing uid in URL.";
  throw new Error("Missing uid");
}

function postCardHTML(p){
  const title = p.title ?? "Untitled catch";
  const state = p.state ?? "Unknown";
  const imageUrl = p.imageUrl ?? "";

  return `
    <div class="card">
      ${imageUrl ? `<img class="post-img" src="${imageUrl}" />` : ""}
      <p class="title">${title}</p>
      <p class="meta">${state}</p>
    </div>
  `;
}

async function load(){
  statusEl.textContent = "Loading profile…";

  try{
    const pSnap = await getDoc(doc(db, "profiles", uid));
    if (pSnap.exists()){
      const p = pSnap.data();
      nameEl.textContent = p.displayName || "Member";
      homeStateEl.textContent = p.homeState || "";
      if (p.photoUrl){
        avatarEl.src = p.photoUrl;
      }
      profileCard.style.display = "block";
    }
  }catch(e){
    statusEl.textContent = "❌ Profile load failed: " + e.message;
    return;
  }

  statusEl.textContent = "Loading posts…";

  try{
    const snap = await getDocs(query(
      collection(db, "posts"),
      where("userId", "==", uid)
    ));

    let posts = [];
    snap.forEach(d => posts.push(d.data()));

    countEl.textContent = posts.length;
    gridEl.innerHTML = posts.map(postCardHTML).join("");

    statusEl.textContent = "Loaded.";
  }catch(e){
    statusEl.textContent = "❌ Post load failed: " + e.message;
  }
}

load();
</script>
</body>
</html>
